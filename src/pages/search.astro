---
import BaseLayout from '@/layouts/BaseLayout.astro';
import BlogCard from '@/components/BlogCard.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('blog');
const publishedPosts = posts
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime());

// Get search query from URL
const searchParams = Astro.url.searchParams;
const query = searchParams.get('q') || '';

// Filter posts based on search query
const searchResults = query
  ? publishedPosts.filter(
      (post) =>
        post.data.title.toLowerCase().includes(query.toLowerCase()) ||
        post.data.description.toLowerCase().includes(query.toLowerCase()) ||
        post.data.tags.some((tag) =>
          tag.toLowerCase().includes(query.toLowerCase())
        ) ||
        post.data.category.toLowerCase().includes(query.toLowerCase())
    )
  : [];
---

<BaseLayout
  title={`Search Results - Modern Astro Blog`}
  description={`Search results for "${query}"`}
>
  <section class="container py-12">
    <div class="mx-auto mb-12 max-w-2xl text-center">
      <h1 class="text-4xl font-bold tracking-tight sm:text-5xl">Search</h1>
      <p class="mt-4 text-lg text-muted-foreground">
        Find articles, tutorials, and insights
      </p>
    </div>

    <div class="mx-auto max-w-4xl">
      <form class="mb-8">
        <div class="relative">
          <input
            type="search"
            name="q"
            value={query}
            placeholder="Search articles..."
            class="w-full rounded-lg border bg-background px-4 py-3 pr-12 text-foreground placeholder:text-muted-foreground focus:border-primary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
          />
          <button
            type="submit"
            class="absolute right-2 top-1/2 -translate-y-1/2 rounded-md p-2 text-muted-foreground hover:text-foreground"
            aria-label="Search"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>
        </div>
      </form>

      {
        query && (
          <div class="mb-6 text-center">
            <p class="text-muted-foreground">
              {searchResults.length === 0
                ? `No results found for "${query}"`
                : `Found ${searchResults.length} result${
                    searchResults.length === 1 ? '' : 's'
                  } for "${query}"`}
            </p>
          </div>
        )
      }

      {
        query && searchResults.length > 0 && (
          <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {searchResults.map((post) => (
              <BlogCard post={post} />
            ))}
          </div>
        )
      }

      {
        !query && (
          <div class="py-12 text-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="48"
              height="48"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mx-auto mb-4 text-muted-foreground"
            >
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
            <p class="text-muted-foreground">
              Start typing to search articles...
            </p>
          </div>
        )
      }
    </div>
  </section>
</BaseLayout>
