---
/**
 * View Counter Component
 * Tracks and displays page view counts using localStorage
 * For production, integrate with Vercel Analytics or a database
 */
export interface Props {
  slug: string;
  showLabel?: boolean;
}

const { slug, showLabel = true } = Astro.props;
---

<div class="view-counter inline-flex items-center gap-1 text-sm text-muted-foreground" data-slug={slug}>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="14"
    height="14"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
    <circle cx="12" cy="12" r="3"/>
  </svg>
  <span class="view-count">--</span>
  {showLabel && <span class="view-label">views</span>}
</div>

<script>
  interface ViewData {
    [slug: string]: {
      count: number;
      lastViewed: number;
    };
  }

  function initViewCounter() {
    const counters = document.querySelectorAll('.view-counter[data-slug]');
    
    counters.forEach((counter) => {
      const slug = counter.getAttribute('data-slug');
      if (!slug) return;
      
      const countElement = counter.querySelector('.view-count');
      if (!countElement) return;
      
      // Get view data from localStorage
      const storageKey = 'astronova_views';
      let viewData: ViewData = {};
      
      try {
        const stored = localStorage.getItem(storageKey);
        viewData = stored ? JSON.parse(stored) : {};
      } catch (e) {
        viewData = {};
      }
      
      // Initialize if not exists
      if (!viewData[slug]) {
        viewData[slug] = { count: 0, lastViewed: 0 };
      }
      
      // Check if this is a new view (not viewed in last 30 minutes)
      const now = Date.now();
      const thirtyMinutes = 30 * 60 * 1000;
      
      if (now - viewData[slug].lastViewed > thirtyMinutes) {
        viewData[slug].count++;
        viewData[slug].lastViewed = now;
        
        try {
          localStorage.setItem(storageKey, JSON.stringify(viewData));
        } catch (e) {
          console.error('Failed to save view count:', e);
        }
      }
      
      // Display count
      const count = viewData[slug].count;
      countElement.textContent = formatCount(count);
    });
  }
  
  function formatCount(count: number): string {
    if (count >= 10000) {
      return (count / 10000).toFixed(1) + 'w';
    } else if (count >= 1000) {
      return (count / 1000).toFixed(1) + 'k';
    }
    return count.toString();
  }
  
  // Initialize on load
  document.addEventListener('DOMContentLoaded', initViewCounter);
  document.addEventListener('astro:page-load', initViewCounter);
  
  if (document.readyState !== 'loading') {
    initViewCounter();
  }
</script>
