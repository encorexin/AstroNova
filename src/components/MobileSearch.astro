---
/**
 * Mobile Search Component
 */
---

<!-- Search Button -->
<button
  type="button"
  id="mobileSearchOpen"
  class="flex h-9 w-9 items-center justify-center rounded-md text-muted-foreground transition-colors hover:bg-muted hover:text-foreground md:hidden"
  aria-label="Search"
>
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="11" cy="11" r="8"></circle>
    <path d="m21 21-4.35-4.35"></path>
  </svg>
</button>

<!-- Search Modal -->
<div 
  id="mobileSearchOverlay" 
  style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;z-index:999999;background-color:hsl(var(--background));overflow:hidden;"
>
  <div style="display:flex;flex-direction:column;height:100%;padding:16px;padding-top:max(16px, env(safe-area-inset-top));">
    <!-- Header -->
    <div style="display:flex;align-items:center;gap:12px;flex-shrink:0;">
      <input
        type="text"
        id="mobileSearchField"
        placeholder="Search articles..."
        style="flex:1;padding:12px 16px;border-radius:8px;border:1px solid hsl(var(--border));background:hsl(var(--background));color:hsl(var(--foreground));font-size:16px;outline:none;"
        inputmode="search"
        autocomplete="off"
      />
      <button
        type="button"
        id="mobileSearchClose"
        style="padding:8px 12px;font-size:14px;font-weight:500;color:hsl(var(--primary));background:none;border:none;cursor:pointer;"
      >
        Cancel
      </button>
    </div>
    <!-- Results -->
    <div 
      id="mobileSearchOutput" 
      style="flex:1;overflow-y:auto;margin-top:16px;-webkit-overflow-scrolling:touch;"
    >
      <div style="padding:32px 0;text-align:center;color:hsl(var(--muted-foreground));">
        <p>Type to search articles</p>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('astro:page-load', initMobileSearch);
  document.addEventListener('DOMContentLoaded', initMobileSearch);
  
  let mobileSearchInitialized = false;
  
  function initMobileSearch() {
    if (mobileSearchInitialized) return;
    
    const openBtn = document.getElementById('mobileSearchOpen');
    const closeBtn = document.getElementById('mobileSearchClose');
    const overlay = document.getElementById('mobileSearchOverlay');
    const field = document.getElementById('mobileSearchField') as HTMLInputElement | null;
    const output = document.getElementById('mobileSearchOutput');
    
    if (!openBtn || !closeBtn || !overlay || !field || !output) {
      return;
    }
    
    mobileSearchInitialized = true;
    console.log('[MobileSearch] Initialized');
    
    let articles: any[] | null = null;
    let searchTimer: number | undefined;
    let scrollPos = 0;
    
    async function loadArticles() {
      if (articles !== null) return;
      try {
        const res = await fetch('/api/search.json');
        articles = await res.json();
        console.log('[MobileSearch] Loaded', articles?.length, 'articles');
      } catch (e) {
        console.error('[MobileSearch] Load failed:', e);
        articles = [];
      }
    }
    
    function openSearch() {
      if (!overlay || !field || !output) return;
      
      scrollPos = window.scrollY;
      overlay.style.display = 'block';
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.top = `-${scrollPos}px`;
      document.body.style.width = '100%';
      field.value = '';
      output.innerHTML = '<div style="padding:32px 0;text-align:center;color:hsl(var(--muted-foreground));"><p>Type to search articles</p></div>';
      setTimeout(() => field.focus(), 50);
      loadArticles();
    }
    
    function closeSearch() {
      if (!overlay) return;
      
      overlay.style.display = 'none';
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.width = '';
      window.scrollTo(0, scrollPos);
    }
    
    async function doSearch() {
      if (!field || !output) return;
      
      const query = field.value.trim().toLowerCase();
      
      if (query.length < 2) {
        output.innerHTML = '<div style="padding:32px 0;text-align:center;color:hsl(var(--muted-foreground));"><p>Type to search articles</p></div>';
        return;
      }
      
      if (!articles) {
        output.innerHTML = '<div style="padding:32px 0;text-align:center;color:hsl(var(--muted-foreground));"><p>Loading...</p></div>';
        await loadArticles();
      }
      
      if (!articles || articles.length === 0) {
        output.innerHTML = '<div style="padding:32px 0;text-align:center;color:hsl(var(--muted-foreground));"><p>No articles found</p></div>';
        return;
      }
      
      const results = articles.filter((a: any) => {
        const titleMatch = a.title?.toLowerCase().includes(query);
        const descMatch = a.description?.toLowerCase().includes(query);
        const catMatch = a.category?.toLowerCase().includes(query);
        const tagMatch = a.tags?.some((t: string) => t.toLowerCase().includes(query));
        return titleMatch || descMatch || catMatch || tagMatch;
      });
      
      console.log('[MobileSearch] Search:', query, 'Results:', results.length);
      
      if (results.length === 0) {
        output.innerHTML = `<div style="padding:32px 0;text-align:center;color:hsl(var(--muted-foreground));"><p>No results for "${escapeHtml(query)}"</p></div>`;
        return;
      }
      
      let html = '';
      results.slice(0, 10).forEach((item: any) => {
        html += `
          <a href="${item.url}" style="display:block;padding:16px;border:1px solid hsl(var(--border));border-radius:8px;margin-bottom:12px;text-decoration:none;color:inherit;">
            <div style="font-size:12px;color:hsl(var(--muted-foreground));margin-bottom:4px;">${escapeHtml(item.category || '')}</div>
            <div style="font-weight:500;color:hsl(var(--foreground));">${highlightMatch(item.title || '', query)}</div>
            <div style="font-size:14px;color:hsl(var(--muted-foreground));margin-top:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${highlightMatch(item.description || '', query)}</div>
          </a>
        `;
      });
      output.innerHTML = html;
    }
    
    function escapeHtml(str: string): string {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    
    function highlightMatch(text: string, query: string): string {
      const escaped = escapeHtml(text);
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return escaped.replace(regex, '<mark style="background:#fef08a;border-radius:2px;padding:0 2px;">$1</mark>');
    }
    
    openBtn.addEventListener('click', (e) => {
      e.preventDefault();
      openSearch();
    });
    
    closeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      closeSearch();
    });
    
    field.addEventListener('input', () => {
      clearTimeout(searchTimer);
      searchTimer = window.setTimeout(doSearch, 250);
    });
    
    field.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSearch();
    });
  }
</script>
