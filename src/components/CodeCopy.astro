---
/**
 * Code Copy Button Component
 * Adds copy buttons to all code blocks on the page
 */
---

<script>
  function initCodeCopy() {
    // Find all code blocks
    const codeBlocks = document.querySelectorAll('pre:not([data-copy-init])');
    
    codeBlocks.forEach((pre) => {
      // Mark as initialized
      pre.setAttribute('data-copy-init', 'true');
      
      // Skip if already has button
      if (pre.querySelector('.copy-code-btn')) return;
      
      // Create wrapper if needed
      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper relative group';
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);
      
      // Create copy button
      const button = document.createElement('button');
      button.className = 'copy-code-btn';
      button.setAttribute('aria-label', 'Copy code');
      button.innerHTML = `
        <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
          <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
        </svg>
        <svg class="check-icon hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      `;
      
      // Add click handler
      button.addEventListener('click', async () => {
        const code = pre.querySelector('code');
        const text = code?.textContent || pre.textContent || '';
        
        try {
          await navigator.clipboard.writeText(text);
          
          // Show success state
          button.classList.add('copied');
          button.querySelector('.copy-icon')?.classList.add('hidden');
          button.querySelector('.check-icon')?.classList.remove('hidden');
          
          // Reset after 2 seconds
          setTimeout(() => {
            button.classList.remove('copied');
            button.querySelector('.copy-icon')?.classList.remove('hidden');
            button.querySelector('.check-icon')?.classList.add('hidden');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
      
      wrapper.appendChild(button);
    });
  }
  
  // Initialize on load
  document.addEventListener('DOMContentLoaded', initCodeCopy);
  document.addEventListener('astro:page-load', initCodeCopy);
  
  // Run immediately if DOM is ready
  if (document.readyState !== 'loading') {
    initCodeCopy();
  }
</script>

<style is:global>
  .code-block-wrapper {
    position: relative;
  }
  
  .copy-code-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    padding: 6px;
    border-radius: 6px;
    background: hsl(var(--muted) / 0.8);
    border: 1px solid hsl(var(--border));
    color: hsl(var(--muted-foreground));
    cursor: pointer;
    opacity: 0;
    transition: all 0.2s ease;
    z-index: 10;
  }
  
  .code-block-wrapper:hover .copy-code-btn,
  .copy-code-btn:focus {
    opacity: 1;
  }
  
  .copy-code-btn:hover {
    background: hsl(var(--muted));
    color: hsl(var(--foreground));
  }
  
  .copy-code-btn.copied {
    background: hsl(var(--primary) / 0.1);
    color: hsl(var(--primary));
    border-color: hsl(var(--primary) / 0.3);
  }
  
  .copy-code-btn svg {
    display: block;
  }
  
  .copy-code-btn .hidden {
    display: none;
  }
  
  /* Mobile: always show button */
  @media (max-width: 768px) {
    .copy-code-btn {
      opacity: 1;
    }
  }
</style>
